<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Topic Task</title>

  <!-- ===================  MINIMAL DARK THEME  =================== -->
  <style>
    :root {
      --bg: #000;          /* page background  */
      --fg: #fff;          /* normal text      */
      --input-bg: #1a1a1a; /* inputs / buttons */
      --border-color:#444;
    }
    *      { box-sizing:border-box; }
    html,body{
      margin:0;
      font-family:system-ui,sans-serif;
      background:var(--bg);
      color:var(--fg);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
    }
    #stage{
      width:92%;
      max-width:860px;
      padding:2rem;
      text-align:center;
    }
    button,
    input[type=text],
    input[type=number],
    select {
      font-size:1rem;
      padding:.5rem 1rem;
      margin:.3rem;
      background:var(--input-bg);
      color:var(--fg);
      border:1px solid var(--border-color);
      border-radius: 4px;
    }
    button{
      cursor:pointer;
      background:#222;
    }
    button:hover{
      background:#333;
      border-color:#555;
    }
    audio{ display:none; }
    
    /* --- Form & Questionnaire Styles --- */
    .form-container {
      text-align:left;
      display:inline-block;
      max-width: 600px;
      width: 100%;
    }
    .form-container p { text-align:center; }
    .form-container label {
      display: block;
      margin-top: 1rem;
      margin-bottom: .25rem;
      font-weight: bold;
    }
    .form-container input[type=radio] { margin-right: .5rem; }
    .pis-content { /* Also used for debrief */
      height: 300px;
      overflow-y: scroll;
      border: 1px solid var(--border-color);
      padding: 1rem;
      text-align: left;
      margin-bottom: 1rem;
      background: var(--input-bg);
    }
    .button-bar { margin-top: 1.5rem; text-align: center; }

    /* --- PIS Full-Screen Mode --- */
    body.pis-mode {
      align-items: flex-start;
      justify-content: center;
    }
    body.pis-mode #stage {
      padding-top: 4vh;
      padding-bottom: 4vh;
      text-align: left;
      max-width: 900px; /* ★ Widen PIS container */
    }
    body.pis-mode .pis-content {
      height: auto;
      overflow-y: visible;
      border: none;
      padding: 0;
      background: none;
      margin-bottom: 0;
      line-height: 1.6; /* ★ Add line-height for readability */
    }
    /* ★ Styles from PIS.txt for clean formatting */
    .pis-content h1 { font-size: 1.8em; margin-bottom: 0.4em; }
    .pis-content h2 { font-size: 1.25em; margin-top: 1.8em; }
    .pis-content ul { margin-left: 1.2em; text-align: left; }
    .pis-content p { text-align: left; }
    .pis-content a { color: #0645AD; text-decoration: none; }
    .pis-content a:hover { text-decoration: underline; }


    /* ---------- Experiment‑specific helpers ---------- */
    .fixation-cross-container{
      font-size:2rem;
      height:6em;
      display:flex;align-items:center;justify-content:center;
    }
    .test-sentence-container{
      min-height:6em;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
    }
    .study-listen-screen{
      display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px;
    }
    .study-listen-screen .fixation{ font-size:3rem;margin:0; }
    .study-listen-screen .instruction{ font-size:1.5rem;margin-top:.5em; }
  </style>
</head>
<body>
  <div id="stage">Loading stimuli…</div>

<script>
/* ===================================================================
 * SERIAL‑POSITION MEMORY TASK  (HTML + Vanilla JS)
 * – Study (15 audio sentences)            – no response
 * – Distractor (count high beeps)         – numeric response
 * – Test   (30 text sentences OLD/NEW)    – F=OLD  J=NEW
 * – Data sent to DataPipe → OSF           – CSV fallback download
 * =================================================================== */

/* -------------- CONFIG -------------- */
const CONFIG = {
  experimentName       : 'Audio Task',
  audioDir             : 'audio',               // audio/*.wav
  csvFile              : 'stimulus_master.csv', // stimuli list
  pisFile              : 'PIS.txt',             // PIS file
  debriefFile          : 'debrief.txt',         // <-- NEW: Debrief file
  responseKeys         : { old:'f', new:'j' },
  dataPipeID           : 'qWHxwr6D720q',        // ← your real DataPipe ID
  fallbackDownload     : true,                  // save CSV locally on failure
  fixationCrossDuration: 500,                   // ms

  /* ★ Fixed column order */
  masterHeader : [
    'participant','difficulty','topic','phase',
    'file','sentence','serialPos',
    'isOld','serialPosTest','respOld','correct',
    'trueHigh','resp','corrDistractor','rt',
    'age','gender','education','familiarityChess','familiarityCloud','randomResponses'
  ]
};

/* -------------- GLOBAL STATE -------------- */
const state = {
  participant : '',
  difficulty  : '',
  blockOrder  : [],
  stimuliPool : [],
  data        : [],
  questionnaire: {}
};

const stage      = document.getElementById('stage');
let   startClock = 0;      // RT timer

/* -------------- UTILITIES -------------- */
const sleep   = ms => new Promise(r=>setTimeout(r,ms));
const shuffle = arr=>{
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  } return arr;
};
const randomSample=(arr,n)=>shuffle([...arr]).slice(0,n);

function beep(freq,dur=0.2){
  return new Promise(res=>{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.frequency.value=freq;
    osc.connect(gain); gain.connect(ctx.destination);
    osc.start();
    gain.gain.setValueAtTime(1,ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+dur);
    osc.stop(ctx.currentTime+dur);
    setTimeout(()=>{ctx.close();res();},dur*1000);
  });
}

function log(row){
  ['isOld','respOld','correct','corrDistractor']
    .forEach(k=>{ if(k in row) row[k]=row[k]?1:0; });
  if('rt' in row && typeof row.rt==='number') row.rt = row.rt/1000;
  state.data.push(row);
}

function toCSV(rows){
  if (!rows.length) return '';
  const header = CONFIG.masterHeader;
  const lines  = [header.join(',')];
  rows.forEach(r=>{
    const line = header.map(k=>{
      let cell = (k in r && r[k]!==undefined) ? r[k] : '';
      cell = String(cell);
      if (/[",\n\r]/.test(cell))
        cell = '"' + cell.replace(/"/g,'""') + '"';
      return cell;
    }).join(',');
    lines.push(line);
  });
  return lines.join('\n');
}

function uploadCSV(filename,csv){
  return fetch('https://pipe.jspsych.org/api/data',{
    method :'POST',
    headers:{'Content-Type':'application/json'},
    body   : JSON.stringify({
      experimentID: CONFIG.dataPipeID,
      filename    : filename,
      data        : csv
    })
  });
}

function downloadFile(content, fn, type){
  const blob=new Blob([content],{type:type});
  const url =URL.createObjectURL(blob);
  const a   =document.createElement('a');
  a.href=url; a.download=fn; a.click();
  URL.revokeObjectURL(url);
}

const show = html => stage.innerHTML = html;


/* ==================================================================
 * ======================= NEW FUNCTIONALITIES ======================
 * ================================================================== */

/* -------------- PIS & PRE-SCREENING -------------- */

async function showPIS() {
  const response = await fetch(CONFIG.pisFile);
  if (!response.ok) {
    show('<h2>Error</h2><p>Could not load the Participant Information Sheet. Please contact the researcher.</p>');
    throw new Error('Failed to fetch PIS file');
  }
  const pisText = await response.text();

  const parser = new DOMParser();
  const pisDoc = parser.parseFromString(pisText, 'text/html');
  const pisBodyContent = pisDoc.body.innerHTML;

  document.body.classList.add('pis-mode');

  show(`
    <div class="form-container">
      <div class="pis-content"></div>
      <div class="button-bar">
        <button id="download-pis">Download PIS as PDF</button>
        <button id="next-pis">Next</button>
      </div>
    </div>
  `);
  
  document.querySelector('.pis-content').innerHTML = pisBodyContent;
  
  document.getElementById('download-pis').onclick = () => {
    const a = document.createElement('a');
    a.href = 'PIS.pdf';
    a.download = 'Participant-Information-Sheet.pdf';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };

  return new Promise(resolve => {
    document.getElementById('next-pis').onclick = () => {
      document.body.classList.remove('pis-mode');
      resolve();
    };
  });
}

function exitToProlific() {
  const message = `
    <div class="form-container" style="text-align:center;">
      <h2>Thank you for your interest.</h2>
      <p>As you do not meet the eligibility criteria or do not wish to consent, you cannot proceed with the study.</p>
      <p>You will now be returned to Prolific.</p>
    </div>
  `;
  show(message);
  setTimeout(() => {
    window.location.href = 'https://app.prolific.com';
  }, 5000); // 5 second delay
}

function askYesNoQuestion(questionText) {
  show(`
    <div class="form-container" style="text-align: center;">
      <p style="text-align: left; font-size: 1.2rem; margin-bottom: 2rem;">${questionText}</p>
      <button id="yes-btn">Yes</button>
      <button id="no-btn">No</button>
    </div>
  `);
  return new Promise(resolve => {
    document.getElementById('yes-btn').onclick = () => resolve(true);
    document.getElementById('no-btn').onclick = () => resolve(false);
  });
}

async function runScreeningSequence() {
  const questions = [
    'Are you over 18 years of age?',
    'During the study, will you have access to speakers or headphones and a quiet place to listen?',
    'Do you consent to participate in the study?'
  ];

  for (const question of questions) {
    const answeredYes = await askYesNoQuestion(question);
    if (!answeredYes) {
      exitToProlific();
      // Return a promise that never resolves to halt execution
      return new Promise(() => {}); 
    }
  }
}

/* -------------- POST-TASK QUESTIONNAIRES -------------- */

async function showDemographics() {
  show(`
    <div class="form-container">
      <h1>Demographic Information</h1>
      <p>Please provide the following information.</p>

      <label for="age">Age:</label>
      <input type="number" id="age" name="age" min="18" max="100" required>

      <label for="gender">Gender:</label>
      <select id="gender" name="gender" required>
        <option value="" disabled selected>Select an option</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="nonbinary">Non-binary</option>
        <option value="other">Other</option>
        <option value="prefer_not_to_say">Prefer not to say</option>
      </select>

      <label for="education">Highest level of education completed:</label>
      <select id="education" name="education" required>
        <option value="" disabled selected>Select an option</option>
        <option value="high_school">High School</option>
        <option value="bachelors">Bachelor's Degree</option>
        <option value="masters">Master's Degree</option>
        <option value="phd">Doctorate (PhD)</option>
        <option value="other">Other</option>
      </select>
      
      <div class="button-bar">
        <button id="continue-demographics">Continue</button>
      </div>
    </div>
  `);

  return new Promise(resolve => {
    document.getElementById('continue-demographics').onclick = () => {
      const age = document.getElementById('age').value;
      const gender = document.getElementById('gender').value;
      const education = document.getElementById('education').value;

      if (age && gender && education) {
        state.questionnaire.age = age;
        state.questionnaire.gender = gender;
        state.questionnaire.education = education;
        resolve();
      } else {
        alert('Please complete all fields.');
      }
    };
  });
}

async function showPostTask() {
  show(`
    <div class="form-container">
      <h1>Post-Task Questions</h1>
      <p>Please answer a few final questions about your experience.</p>

      <label>How familiar are you with the topic of Chess? (1=Not familiar, 5=Very familiar)</label>
      <div>
        <input type="radio" name="fam_chess" value="1"> 1 <input type="radio" name="fam_chess" value="2"> 2 <input type="radio" name="fam_chess" value="3"> 3 <input type="radio" name="fam_chess" value="4"> 4 <input type="radio" name="fam_chess" value="5"> 5
      </div>

      <label>How familiar are you with the topic of Cloud Computing? (1=Not familiar, 5=Very familiar)</label>
      <div>
        <input type="radio" name="fam_cloud" value="1"> 1 <input type="radio" name="fam_cloud" value="2"> 2 <input type="radio" name="fam_cloud" value="3"> 3 <input type="radio" name="fam_cloud" value="4"> 4 <input type="radio" name="fam_cloud" value="5"> 5
      </div>
      
      <label>Did you respond randomly at any point during the memory test?</label>
      <input type="radio" name="random" value="yes" id="random-yes"><label for="random-yes">Yes</label>
      <input type="radio" name="random" value="no" id="random-no"><label for="random-no">No</label>

      <div class="button-bar">
        <button id="continue-post-task">Finish Experiment</button>
      </div>
    </div>
  `);

  return new Promise(resolve => {
    document.getElementById('continue-post-task').onclick = () => {
      const famChess = document.querySelector('input[name="fam_chess"]:checked');
      const famCloud = document.querySelector('input[name="fam_cloud"]:checked');
      const random = document.querySelector('input[name="random"]:checked');

      if (famChess && famCloud && random) {
        state.questionnaire.familiarityChess = famChess.value;
        state.questionnaire.familiarityCloud = famCloud.value;
        state.questionnaire.randomResponses = random.value;
        resolve();
      } else {
        alert('Please answer all questions.');
      }
    };
  });
}

function mergeData() {
  state.data.forEach(row => {
    Object.assign(row, state.questionnaire);
  });
}

// --- MODIFIED: showDebrief is now async and fetches external file ---
async function showDebrief(success = true) {
  if (success) {
    const response = await fetch(CONFIG.debriefFile);
    const debriefHtml = response.ok ? await response.text() : '<p>Thank you for your participation.</p>';
    
    const successMessage = `
      <div class="form-container">
        <h1>Debriefing Information</h1>
        <div class="pis-content">${debriefHtml}</div>
        <p><strong>Your data has been successfully uploaded.</strong></p>
        <p>You may now close this window.</p>
      </div>`;
    show(successMessage);

  } else {
    const failureMessage = `
      <h2>Network error – data downloaded locally.</h2>
      <p>There was an issue uploading your data. A file containing your data has been downloaded to your computer instead.</p>
      <p>Please email this CSV file to the researcher.</p>`;
    const genericFailureMessage = '<h2>Sorry – data could not be saved.</h2><p>Please screenshot this page and contact the researcher.</p>';
    
    if (CONFIG.fallbackDownload) {
      show(failureMessage);
    } else {
      show(genericFailureMessage);
    }
  }
}

/* ==================================================================
 * ======================= CORE EXPERIMENT LOGIC ====================
 * ================================================================== */


/* -------------- LOAD STIMULI CSV -------------- */
async function loadCSV(){
  const txt = await fetch(CONFIG.csvFile).then(r=>r.text());
  const lines = txt.trim().split(/\r?\n/);
  lines.shift();

  lines.forEach(line=>{
    const comma = line.indexOf(',');
    if(comma===-1) return;
    const file     = line.slice(0,comma).trim();
    const sentence = line.slice(comma+1).trim();
    const m = /(Ch|Cl)(E|H)(\d{2})\.(wav|mp3|ogg)$/i.exec(file);
    if(!m) return;
    state.stimuliPool.push({
      file, sentence,
      topic : m[1].toLowerCase()==='ch'?'Chess':'Cloud',
      diff  : m[2].toUpperCase(),
      idx   : parseInt(m[3],10)
    });
  });
  if(!state.stimuliPool.length)
    throw new Error('No stimuli loaded – check CSV.');
}

/* -------------- MAIN INTRO SCREEN -------------- */
async function intro(){
  show(`
    <h1>${CONFIG.experimentName}</h1>
    <p>Please enter your Prolific ID to begin.</p>
    <input id="pid"  placeholder="Prolific ID" /><br>
    <button id="start">Start</button>
  `);

  document.getElementById('start').onclick = () => {
    const pid  = document.getElementById('pid').value.trim();

    if (!pid){ alert('Please enter a Prolific ID'); return; }

    state.participant = pid;
    // ★ Randomly assign participant to 'E' (Easy) or 'H' (Hard) condition
    state.difficulty  = Math.random() < 0.5 ? 'E' : 'H';
    state.blockOrder  = shuffle(['Chess','Cloud']);

    blockLoop(0);
  };
}

/* ----- block loop ----- */
async function blockLoop(i){
  // ★ BUG FIX: Was 'state.block.length', corrected to 'state.blockOrder.length'
  if(i>=state.blockOrder.length) { 
    await showDemographics();
    await showPostTask();
    await finishExperiment();
    return;
  }
  await runBlock(state.blockOrder[i]);
  blockLoop(i+1);
}

/* -------------- RUN BLOCK (Study → Distractor → Test) -------------- */
async function runBlock(topic){
  const pool = state.stimuliPool
                .filter(s=>s.topic===topic && s.diff===state.difficulty);
  if(pool.length<30) throw new Error('Insufficient stimuli');

  const study     = randomSample(pool,15);
  const newFoils  = randomSample(pool.filter(s=>!study.includes(s)),15);
  const testList  = shuffle([...study,...newFoils]);

  /* ---- Study ---- */
  show(`<h2>Study – ${topic}</h2><p>You will hear 15 sentences. Listen carefully.</p><p>Press SPACE to begin.</p>`);
  await waitSpace();
  for(let i=0;i<study.length;i++){
    show(`<div class="study-listen-screen"><p class="fixation">+</p><p class="instruction">Listen carefully.</p></div>`);
    await playAudio(study[i].file);
    log({participant:state.participant,difficulty:state.difficulty, topic,phase:'study',serialPos:i+1, file:study[i].file,sentence:study[i].sentence});
    await sleep(100);
  }

  /* ---- Distractor ---- */
  await distractorPhase(topic);

  /* ---- Test ---- */
  show(`
    <h2>Memory Test – ${topic}</h2>
    <p>You will now see 30 sentences, one at a time. Some are OLD and some are NEW.</p>
    <p>Your task is to decide for each sentence: F = OLD or J = NEW</p>
    <p>Please respond as quickly and accurately as possible.</p>
    <p>Press the SPACEBAR when you are ready to begin.</p>
  `);
  await waitSpace();
  for(const stim of testList){
    show(`<div class="fixation-cross-container">+</div>`);
    await sleep(CONFIG.fixationCrossDuration);
    show(`<div class="test-sentence-container"><p style="font-size:1.5rem;">${stim.sentence}</p><p style="font-size:.8em;margin-top:1em;">(F = OLD &nbsp;|&nbsp; J = NEW)</p></div>`);
    startClock = performance.now();
    const key  = await waitKeys(['f','j']);
    const rt   = performance.now() - startClock;
    const isOld= study.includes(stim);
    log({participant:state.participant,difficulty:state.difficulty, topic,phase:'test',file:stim.file,sentence:stim.sentence, isOld,serialPosTest:isOld?study.indexOf(stim)+1:-1, respOld:key==='f',correct:(key==='f')===isOld,rt});
  }
}

/* -------------- HELPERS -------------- */
function playAudio(fname){
  return new Promise(res=>{
    const a=new Audio(`${CONFIG.audioDir}/${fname}`);
    a.addEventListener('ended',()=>res());
a.play();
  });
}
const waitSpace=()=>waitKeys([' ']);
function waitKeys(valid){
  valid = valid.map(k=>k.toLowerCase());
  return new Promise(res=>{
    function onKey(e){
      const k=e.key.toLowerCase();
      if(valid.includes(k)){
        document.removeEventListener('keydown',onKey);
        res(k);
      }
    }
    document.addEventListener('keydown',onKey);
  });
}

/* ----- distractor count‑the‑high‑beeps ----- */
async function distractorPhase(topic){
  const numHigh = Math.floor(Math.random()*8)+1;
  const seq     = shuffle(Array(numHigh).fill('high').concat(Array(8-numHigh).fill('low')));

  show(`<h2>Counting task</h2><p>Count ONLY the high‑pitched beeps in 8 tones.</p><p>Press SPACE to start.</p>`);
  await waitSpace();

  let firstToneTime=0;
  for(let i=0;i<seq.length;i++){
    if(i===0) firstToneTime=performance.now();
    await beep(seq[i]==='high'?1000:400,0.2);
    await sleep(50);
  }
  show(`<p>How many high beeps? (Press 1‑8)</p>`);
  const key = await waitKeys(['1','2','3','4','5','6','7','8']);
  const rt  = performance.now()-firstToneTime;
  log({participant:state.participant,difficulty:state.difficulty, topic,phase:'distractor',trueHigh:numHigh,resp:+key, corrDistractor:(+key)===numHigh,rt});
}

/* -------------- FINISH & UPLOAD -------------- */
async function finishExperiment(){
  mergeData();
  const csv = toCSV(state.data);
  const fn  = `${CONFIG.experimentName}_${state.participant}_${Date.now()}.csv`;

  show('<h2>Uploading your data…</h2><p>Please wait.</p>');
  try {
    const r = await uploadCSV(fn, csv);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    await r.json();
    await showDebrief(true);
  } catch (err) {
    console.error('Upload failed:', err);
    if (CONFIG.fallbackDownload) {
      downloadFile(csv, fn, 'text/csv');
    }
    await showDebrief(false);
  }
}

/* -------------- LAUNCH -------------- */
(async()=>{
  try{
    await loadCSV();
    await showPIS();
    await runScreeningSequence();
    intro();
  }catch(e){
    console.error(e);
    show(`<p>Error: ${e.message}</p>`);
  }
})();
</script>
</body>
</html>
